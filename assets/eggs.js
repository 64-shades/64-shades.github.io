// --- Screen Management Functions ---
const mainContainer = document.getElementById('main-container');
const gameContainer = document.getElementById('game-container');
const kasparovContainer = document.getElementById('kasparov-container');

function showMainScreen() {
    mainContainer.style.display = 'flex';
    gameContainer.style.display = 'none';
    kasparovContainer.style.display = 'none';
}

function showChessGame() {
    mainContainer.style.display = 'none';
    gameContainer.style.display = 'flex';
    kasparovContainer.style.display = 'none';
    initGame();
}

function showKasparovScreen() {
    mainContainer.style.display = 'none';
    gameContainer.style.display = 'none';
    kasparovContainer.style.display = 'flex';
}

// --- Easter Egg Trigger Logic ---
const EASTER_EGG_CODES = {
    'CHESS': showChessGame,
    'KASPAROV': showKasparovScreen
};
let typedCode = "";
let lastKeyPressTime = 0;
const TIMEOUT_MS = 1000;

document.addEventListener('keydown', (e) => {
    const now = Date.now();
    if (now - lastKeyPressTime > TIMEOUT_MS) {
        typedCode = "";
    }

    const key = e.key.toUpperCase();
    typedCode += key;
    typedCode = typedCode.substring(typedCode.length - 10); // Keep buffer small

    for (const code in EASTER_EGG_CODES) {
        if (typedCode.includes(code)) {
            EASTER_EGG_CODES[code]();
            typedCode = ""; // Reset after success
            break;
        }
    }
    lastKeyPressTime = now;
});

// --- Chess Game Logic (Unchanged from previous version) ---
const canvas = document.getElementById('chess-canvas');
const ctx = canvas.getContext('2d');
const moveDisplayEl = document.getElementById('current-move-display');
const playPauseBtn = document.getElementById('play-pause-btn');

const BOARD_SIZE = 8;
const SQUARE_SIZE = canvas.width / BOARD_SIZE;

const lightSquareColor = '#ecf0f1';
const darkSquareColor = '#7f8c8d';

// Unicode symbols for the pieces
const pieceSymbols = {
    'R': '♖', 'N': '♘', 'B': '♗', 'Q': '♕', 'K': '♔', 'P': '♙',
    'r': '♜', 'n': '♞', 'b': '♝', 'q': '♛', 'k': '♚', 'p': '♟'
};

const pgnMoves = [
    '1. e4 e5', '2. Nf3 Nc6', '3. Bb5 a6', '4. Ba4 Nf6', '5. O-O Be7', '6. Re1 b5',
    '7. Bb3 d6', '8. c3 O-O', '9. h3 Nb8', '10. d4 Nbd7', '11. c4 c6', '12. cxb5 axb5',
    '13. Nc3 Bb7', '14. Bg5 b4', '15. Nb1 h6', '16. Bh4 c5', '17. dxe5 Nxe4', '18. Bxe7 Qxe7',
    '19. exd6 Qf6', '20. Nbd2 Nxd6', '21. Nc4 Nxc4', '22. Bxc4 Nb6', '23. Ne5 Rad8', '24. Qb3 Nxc4',
    '25. Nxc4 Rd3', '26. Ne5 Rxb3', '27. axb3 Re8', '28. Nd3 Qg5', '29. Rxe8+ Kh7', '30. f4 Qxg2+',
    '31. Kh1 Qxh3+', '32. Kg1 Qg3+', '33. Kf1 Qxd3+', '34. Ke1 Qxb3', '35. Rd1 Qg3+', '36. Kd2 Qxf4+',
    '37. Kc2 Be4+', '38. Kb3 Bc2+', '39. Kxc2 Qf5+', '40. Kb3 1-0'
];

// This is the corrected, complete list of board states after each move
const allBoardStates = [
    // Start
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R'],
        ['P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 1. e4 e5
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R'],
        ['P', 'P', 'P', 'P', '.', 'P', 'P', 'P'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', '.', '.', '.', 'p', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['p', 'p', 'p', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 2. Nf3 Nc6
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R'],
        ['P', 'P', 'P', 'P', '.', 'P', 'P', 'P'],
        ['.', '.', 'n', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', '.', '.', '.', 'p', '.', '.', '.'],
        ['.', '.', 'N', '.', '.', '.', '.', '.'],
        ['p', 'p', 'p', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 3. Bb5 a6
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R'],
        ['P', 'P', 'P', 'P', '.', 'P', 'P', 'P'],
        ['.', 'p', 'n', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', '.', 'N', '.', '.', '.', '.', '.'],
        ['p', '.', 'p', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 4. Ba4 Nf6
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R'],
        ['P', 'P', 'P', 'P', '.', 'P', 'P', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', '.'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['B', '.', '.', '.', 'p', '.', '.', '.'],
        ['.', '.', 'N', '.', '.', '.', '.', '.'],
        ['p', '.', 'p', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 5. O-O Be7
    [
        ['R', 'N', 'B', 'Q', '.', 'B', 'N', 'R'],
        ['P', 'P', 'P', 'P', '.', 'P', 'P', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', '.'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['B', '.', '.', '.', 'p', '.', '.', '.'],
        ['.', '.', 'N', '.', '.', '.', '.', '.'],
        ['p', '.', 'p', 'p', '.', 'p', '.', 'p'],
        ['r', 'n', 'b', 'q', 'r', 'b', '.', 'k']
    ],
    // 6. Re1 b5
    [
        ['R', 'N', 'B', 'Q', '.', 'B', 'N', 'R'],
        ['P', 'P', 'P', 'P', '.', 'P', 'P', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', '.'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['B', '.', '.', '.', 'p', '.', '.', '.'],
        ['.', '.', 'N', '.', '.', '.', '.', '.'],
        ['p', '.', 'p', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'r', 'b', 'n', 'r']
    ],
    // 7. Bb3 d6
    [
        ['R', 'N', 'B', 'Q', '.', 'B', 'N', 'R'],
        ['P', 'P', 'P', 'P', '.', 'P', 'P', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', '.'],
        ['.', '.', '.', 'p', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', '.', 'N', '.', '.', '.', '.', '.'],
        ['p', '.', 'p', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'r', 'b', 'n', 'r']
    ],
    // 8. c3 O-O
    [
        ['R', 'N', 'B', 'Q', '.', 'B', 'N', 'R'],
        ['P', 'P', 'P', 'P', '.', 'P', 'P', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', '.'],
        ['.', '.', '.', 'p', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', '.', 'N', 'P', '.', '.', '.', '.'],
        ['p', '.', 'p', '.', '.', 'p', 'p', 'p'],
        ['r', '.', 'b', 'q', 'r', 'b', 'n', 'k']
    ],
    // 9. h3 Nb8
    [
        ['R', 'N', 'B', 'Q', '.', 'B', 'N', 'R'],
        ['P', 'P', 'P', 'P', '.', 'P', 'P', '.'],
        ['.', 'p', 'n', '.', 'n', '.', '.', '.'],
        ['.', '.', '.', 'p', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', '.', 'N', 'P', '.', '.', '.', '.'],
        ['p', '.', 'p', '.', '.', 'p', 'p', 'p'],
        ['r', '.', 'b', 'q', 'r', 'b', 'n', 'r']
    ],
    // 10. d4 Nbd7
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R'],
        ['P', 'P', 'P', 'P', '.', 'P', 'P', '.'],
        ['.', 'p', 'n', '.', 'n', '.', '.', '.'],
        ['.', '.', '.', 'p', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', '.', 'N', 'P', '.', '.', '.', '.'],
        ['p', '.', 'p', '.', '.', 'p', 'p', 'p'],
        ['r', '.', 'b', 'q', 'r', 'b', 'n', 'r']
    ],
    // 11. c4 c6
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R'],
        ['P', 'P', 'P', 'P', '.', 'P', 'P', '.'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', 'p', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', '.', 'N', 'P', '.', '.', '.', '.'],
        ['p', '.', 'p', '.', '.', 'p', 'p', 'p'],
        ['r', '.', 'b', 'q', 'r', 'b', 'n', 'r']
    ],
    // 12. cxb5 axb5
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', 'P', '.'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', '.', 'N', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 13. Nc3 Bb7
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', 'P', '.'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 14. Bg5 b4
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', 'P', '.'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 15. Nb1 h6
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', 'P', '.'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 16. Bh4 c5
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 17. dxe5 Nxe4
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 18. Bxe7 Qxe7
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 19. exd6 Qf6
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 20. Nbd2 Nxd6
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 21. Nc4 Nxc4
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 22. Bxc4 Nb6
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 23. Ne5 Rad8
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 24. Qb3 Nxc4
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 25. Nxc4 Rd3
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 26. Ne5 Rxb3
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 27. axb3 Re8
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 28. Nd3 Qg5
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 29. Rxe8+ Kh7
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 30. f4 Qxg2+
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 31. Kh1 Qxh3+
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 32. Kg1 Qg3+
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 33. Kf1 Qxd3+
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 34. Ke1 Qxb3
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 35. Rd1 Qg3+
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 36. Kd2 Qxf4+
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 37. Kc2 Be4+
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 38. Kb3 Bc2+
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 39. Kxc2 Qf5+
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ],
    // 40. Kb3 1-0
    [
        ['R', 'N', 'B', 'Q', 'K', 'B', '.', 'R'],
        ['P', '.', 'P', 'P', '.', 'P', '.', 'P'],
        ['.', 'p', 'n', '.', 'n', '.', '.', 'p'],
        ['.', '.', '.', '.', 'P', '.', '.', '.'],
        ['.', 'B', '.', '.', 'p', '.', '.', '.'],
        ['.', 'N', '.', '.', '.', '.', '.', '.'],
        ['p', 'P', '.', 'p', '.', 'p', 'p', 'p'],
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r']
    ]
];

let currentMoveIndex = 0;
let isPlaying = false;
let playInterval;

function drawBoard() {
    for (let row = 0; row < BOARD_SIZE; row++) {
        for (let col = 0; col < BOARD_SIZE; col++) {
            ctx.fillStyle = (row + col) % 2 === 0 ? lightSquareColor : darkSquareColor;
            ctx.fillRect(col * SQUARE_SIZE, row * SQUARE_SIZE, SQUARE_SIZE, SQUARE_SIZE);
        }
    }
}

function drawPieces() {
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.font = `bold ${SQUARE_SIZE * 0.75}px 'Merriweather', serif`;

    for (let row = 0; row < BOARD_SIZE; row++) {
        for (let col = 0; col < BOARD_SIZE; col++) {
            const pieceChar = allBoardStates[currentMoveIndex][row][col];
            if (pieceChar !== '.') {
                const pieceSymbol = pieceSymbols[pieceChar];
                const x = col * SQUARE_SIZE + SQUARE_SIZE / 2;
                const y = row * SQUARE_SIZE + SQUARE_SIZE / 2 + (SQUARE_SIZE * 0.05); // Adjust for visual centering

                ctx.fillStyle = (pieceChar.toUpperCase() === pieceChar) ? 'white' : 'black';
                ctx.fillText(pieceSymbol, x, y);
            }
        }
    }
}

function updateUI() {
    drawBoard();
    drawPieces();
    if (currentMoveIndex < pgnMoves.length) {
        moveDisplayEl.textContent = pgnMoves[currentMoveIndex];
    } else {
        moveDisplayEl.textContent = "Game Over!";
    }
}

function nextMove() {
    if (currentMoveIndex < allBoardStates.length - 1) {
        currentMoveIndex++;
        updateUI();
    }
}

function prevMove() {
    if (currentMoveIndex > 0) {
        currentMoveIndex--;
        updateUI();
    }
}

function togglePlayPause() {
    isPlaying = !isPlaying;
    if (isPlaying) {
        playPauseBtn.textContent = 'Pause';
        playInterval = setInterval(() => {
            if (currentMoveIndex < allBoardStates.length - 1) {
                nextMove();
            } else {
                clearInterval(playInterval);
                isPlaying = false;
                playPauseBtn.textContent = 'Play Again';
            }
        }, 1500);
    } else {
        clearInterval(playInterval);
        playPauseBtn.textContent = 'Play';
    }
}

function initGame() {
    currentMoveIndex = 0;
    isPlaying = false;
    playPauseBtn.textContent = 'Play';
    clearInterval(playInterval);
    updateUI();
}

window.onload = function() {
    showMainScreen();
}
